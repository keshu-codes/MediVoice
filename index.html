<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Voice-Activated Medication Reminder</title>
    <link rel="icon" href="data:," />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: "Roboto", sans-serif;
        background: linear-gradient(135deg, #e6f4f1, #d0e2e9);
        color: #333;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        flex-direction: column;
        padding: 0 7.5%;
      }
      .container {
        width: 100%;
        max-width: 85%;
        height: auto;
        background: #ffffff;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        border-radius: 15px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 20px;
        margin: 15% auto;
      }
      h2 {
        color: #4caf50;
        margin-bottom: 10px;
        text-align: center;
        font-size: 1.8em;
      }
      .voice-section {
        margin-top: 10px;
        text-align: center;
      }
      .voice-button {
        background: linear-gradient(45deg, #4caf50, #388e3c);
        color: white;
        font-size: 1.1em;
        padding: 12px 25px;
        border: none;
        border-radius: 30px;
        cursor: pointer;
        font-weight: bold;
        transition: background 0.3s, transform 0.2s;
      }
      .voice-button:hover {
        background: linear-gradient(45deg, #388e3c, #4caf50);
        transform: scale(1.05);
      }
      .voice-button.stop {
        background: #ff5252;
      }
      .output {
        background: rgba(0, 0, 0, 0.1);
        padding: 10px;
        border-radius: 8px;
        margin-top: 5px;
        font-style: italic;
        color: #333;
        white-space: pre-wrap;
      }
      .form-group {
        margin-top: 10px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      label {
        font-weight: 600;
        display: block;
        margin-bottom: 4px;
        text-align: center;
        font-size: 0.9em;
        color: #333;
      }
      input,
      select {
        width: 100%;
        max-width: 80%;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #ccc;
        margin-bottom: 10px;
        background: rgba(0, 0, 0, 0.05);
        color: #333;
        font-size: 0.9em;
        transition: border 0.3s;
      }
      input:focus,
      select:focus {
        border: 1px solid #4caf50;
        outline: none;
      }
      .btn {
        width: 100%;
        max-width: 82%;
        background: #4caf50;
        color: white;
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-size: 0.9em;
        font-weight: bold;
        cursor: pointer;
        transition: background 0.3s, transform 0.2s;
      }
      .btn:hover {
        background: #388e3c;
        transform: scale(1.05);
      }
      .success-message {
        color: #4caf50;
        font-weight: bold;
        margin-top: 5px;
        text-align: center;
        font-size: 0.9em;
      }
      .reminder-list,
      .history-list {
        margin-top: 20px;
        background: rgba(255, 255, 255, 0.1);
        padding: 10px;
        border-radius: 10px;
        color: #333;
      }
      .reminder-item,
      .history-item {
        padding: 10px;
        background: rgba(255, 255, 255, 0.15);
        margin-bottom: 10px;
        border-radius: 8px;
        font-size: 0.9em;
        position: relative;
        transition: background-color 0.5s;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        word-wrap: break-word;
      }
      .reminder-item.alert {
        background-color: #ff4444 !important;
        color: #fff !important;
        font-weight: bold;
        box-shadow: 0 0 10px 2px #ff4444;
        animation: pulse 1s infinite alternate;
      }
      @keyframes pulse {
        0% {
          box-shadow: 0 0 10px 2px #ff4444;
        }
        100% {
          box-shadow: 0 0 20px 6px #ff4444;
        }
      }
      .reminder-item button,
      .history-item button {
        background: transparent;
        border: none;
        color: #ff4c4c;
        cursor: pointer;
        position: absolute;
        right: 10px;
        top: 10px;
        font-size: 0.8em;
      }
      .instructions {
        margin-top: 10px;
        color: #4caf50;
        font-size: 0.9em;
        text-align: center;
      }
      @media (max-width: 600px) {
        .container {
          padding: 10px;
          width: 100%;
        }
        .voice-button,
        .btn {
          font-size: 0.9em;
          padding: 10px;
          width: 100%;
        }
        input,
        select {
          width: 100%;
        }
        h2 {
          font-size: 1.5em;
        }
      }

      #popupOverlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }
      .popup {
        background: #fff;
        padding: 20px;
        border-radius: 12px;
        max-width: 90%;
        width: 360px;
        box-shadow: 0 5px 25px rgba(0, 0, 0, 0.3);
        position: relative;
        animation: fadeIn 0.3s ease;
      }
      .close-btn {
        position: absolute;
        right: 12px;
        top: 12px;
        border: none;
        background: none;
        font-size: 1.2em;
        cursor: pointer;
        color: #888;
      }

      #confirmPopupOverlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.4);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 10000;
      }
      .confirm-popup {
        background: #fff;
        padding: 25px 20px;
        border-radius: 10px;
        text-align: center;
        width: 90%;
        max-width: 350px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
        animation: fadeIn 0.25s ease-in-out;
      }
      .confirm-popup p {
        font-size: 1em;
        margin-bottom: 20px;
        color: #333;
      }
      .confirm-popup button {
        background: #4caf50;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 12px 18px;
        font-size: 0.95em;
        cursor: pointer;
        font-weight: bold;
      }
      .confirm-popup button:hover {
        background: #388e3c;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>Instructions</h2>
      <div class="instructions">
        To set a reminder, say: <b>"Aspirin at 9:30 AM"</b> or
        <b>"Paracetamol at 7:45 PM"</b>.
      </div>

      <div class="voice-section">
        <button id="voiceBtn" class="voice-button" onclick="toggleMic()">
          🎤 Start Listening
        </button>
        <div id="voice-output" class="output" style="display: none"></div>
      </div>

      <div class="form-group">
        <h2>Add Medication Reminder</h2>
        <label for="medName">Medication Name</label>
        <input type="text" id="medName" placeholder="e.g. Aspirin" />

        <label for="reminderTime">Reminder Time</label>
        <input type="time" id="reminderTime" />

        <label for="priority">Priority</label>
        <select id="priority">
          <option value="">Select priority</option>
          <option value="Low">Low</option>
          <option value="Medium">Medium</option>
          <option value="High">High</option>
        </select>

        <label><input type="checkbox" id="repeat" /> Repeat Daily</label>

        <button class="btn" onclick="addReminder()">Add Reminder</button>
        <div id="success" class="success-message"></div>
      </div>

      <div class="reminder-list" id="reminderList" style="display: none">
        <h3>All Reminders</h3>
        <div id="reminderItems"></div>
      </div>

      <div class="history-list">
        <h3>Deleted Reminders History</h3>
        <div id="historyItems">No deleted reminders yet.</div>
      </div>

      <audio id="alarmSound" preload="auto">
        <source
          src="https://www.soundjay.com/button/beep-07.wav"
          type="audio/wav"
        />
      </audio>
    </div>

    <div id="popupOverlay">
      <div class="popup">
        <button class="close-btn" onclick="closePopup()">&times;</button>
        <h3 id="popupTitle">Popup Title</h3>
        <div id="popupContent">This is a popup message.</div>
      </div>
    </div>

    <div id="confirmPopupOverlay">
      <div class="confirm-popup">
        <p id="confirmMessage">
          It’s time for your medicine — have you taken it yet?
        </p>
        <button onclick="confirmTaken()">Yes, I took it already.</button>
      </div>
    </div>

    <script>
      let isListening = false;
      let recognition = null;
      let reminders = JSON.parse(localStorage.getItem('reminders')) || [];
      let deletedReminders = JSON.parse(localStorage.getItem('deletedReminders')) || [];
      let activeAlerts = new Set();

      function speak(text) {
        const utter = new SpeechSynthesisUtterance(text);
        window.speechSynthesis.speak(utter);
      }

      function toggleMic() {
        const button = document.getElementById("voiceBtn");
        const output = document.getElementById("voice-output");
        output.style.display = 'block';
        output.textContent = "";

        if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
          showPopup("Error", "Speech Recognition not supported.");
          return;
        }

        if (!recognition) {
          recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
          recognition.lang = 'en-US';
          recognition.interimResults = false;

          recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript.toLowerCase().trim();
            output.textContent = "You said: " + transcript;
            try {
              const parts = transcript.split(" at ");
              if (parts.length !== 2) throw new Error("Invalid format");

              const med = parts[0].trim();
              const timeRaw = parts[1].replace(/a\.?m\.?|p\.?m\.?/g, m => m.includes("p") ? "pm" : "am").replace(/[\s:]/g, '');
              const match = timeRaw.match(/^(\d{1,2})(\d{2})(am|pm)$/);
              if (!match) throw new Error("Time format");

              let hour = parseInt(match[1]), minute = parseInt(match[2]);
              if (match[3] === "pm" && hour < 12) hour += 12;
              if (match[3] === "am" && hour === 12) hour = 0;

              const now = new Date();
              let remTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hour, minute);
              if (remTime < now) remTime.setDate(remTime.getDate() + 1);

              const time = ${String(remTime.getHours()).padStart(2, '0')}:${String(remTime.getMinutes()).padStart(2, '0')};

              reminders.push({
                med,
                time,
                priority: "Medium",
                repeat: false,
                id: Date.now() + Math.random().toString(36),
                timestamp: remTime.getTime()
              });

              localStorage.setItem('reminders', JSON.stringify(reminders)); // Save to local storage
              renderReminders();
              const hour12 = remTime.getHours() % 12 || 12;
              const ampm = remTime.getHours() >= 12 ? "PM" : "AM";
              speak(${med} reminder set at ${hour12}:${String(remTime.getMinutes()).padStart(2, '0')} ${ampm});
              showPopup("Reminder Set", ${med} set for ${hour12}:${String(remTime.getMinutes()).padStart(2, '0')} ${ampm});
            } catch (e) {
              speak("Sorry, I didn't catch that. Try saying: Paracetamol at 9 30 AM.");
              showPopup("Error", "Try saying: Paracetamol at 9:30 AM");
            }
          };

          recognition.onend = () => {
            isListening = false;
            button.textContent = "🎤 Start Listening";
            button.classList.remove("stop");
          };
        }

        if (!isListening) {
          recognition.start();
          isListening = true;
          button.textContent = "⏹ Stop Listening";
          button.classList.add("stop");
          output.textContent = "🎙 Listening... Speak your reminder.";
        } else {
          recognition.stop();
          isListening = false;
          button.textContent = "🎤 Start Listening";
          button.classList.remove("stop");
        }
      }

      function addReminder() {
        const med = document.getElementById("medName").value.trim();
        const time = document.getElementById("reminderTime").value;
        const priority = document.getElementById("priority").value;
        const repeat = document.getElementById("repeat").checked;

        if (!med || !time || !priority) {
          showPopup("Missing Fields", "Please fill all fields and choose a priority.");
          return;
        }

        const now = new Date();
        const [hour, minute] = time.split(":").map(Number);
        let remTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hour, minute);
        if (remTime < now) remTime.setDate(remTime.getDate() + 1);

        const newReminder = { med, time, priority, repeat, id: Date.now() + Math.random().toString(36), timestamp: remTime.getTime() };
        reminders.push(newReminder);
        localStorage.setItem('reminders', JSON.stringify(reminders)); // Save to local storage
        renderReminders();

        showPopup("Reminder Added", ${med} set for ${time} (${priority}));
        document.getElementById("medName").value = "";
        document.getElementById("reminderTime").value = "";
        document.getElementById("priority").value = "";
        document.getElementById("repeat").checked = false;
      }

      function renderReminders() {
        const list = document.getElementById("reminderItems");
        const container = document.getElementById("reminderList");
        list.innerHTML = "";
        if (reminders.length === 0) {
          container.style.display = "none";
          return;
        }
        container.style.display = "block";
        reminders.forEach(r => {
          const div = document.createElement("div");
          div.className = "reminder-item";
          div.id = reminder-${r.id};
          div.innerHTML = `<b>${r.med}</b> at <b>${r.time}</b> - ${r.priority} ${r.repeat ? "(Daily)" : ""}<br>
          <span class="time-left" id="time-left-${r.id}">Calculating...</span>
          <button onclick="deleteReminder('${r.id}')"><i class="fas fa-trash"></i></button>`;
          list.appendChild(div);
        });
      }

      function deleteReminder(id) {
        const r = reminders.find(x => x.id === id);
        if (r) {
          deletedReminders.push(r);
          localStorage.setItem('deletedReminders', JSON.stringify(deletedReminders)); // Save deleted reminders to local storage
        }
        reminders = reminders.filter(x => x.id !== id);
        activeAlerts.delete(id);
                localStorage.setItem('reminders', JSON.stringify(reminders)); // Update local storage
        renderReminders();
        renderHistory();
      }

      function renderHistory() {
        const list = document.getElementById("historyItems");
        if (deletedReminders.length === 0) {
          list.innerHTML = "No deleted reminders yet.";
        } else {
          list.innerHTML = "";
          deletedReminders.forEach(r => {
            const div = document.createElement("div");
            div.className = "history-item";
            div.innerHTML = <b>${r.med}</b> at <b>${r.time}</b> - ${r.priority};
            list.appendChild(div);
          });
        }
      }

      // Load reminders and deleted reminders from local storage on page load
      window.onload = function() {
        renderReminders();
        renderHistory();
      };

      function getTimeLeftString(reminder) {
        const now = new Date();
        let remTime = reminder.timestamp ? new Date(reminder.timestamp) : new Date();
        if (reminder.repeat && remTime < now) remTime.setDate(remTime.getDate() + 1);
        const diff = remTime - now;
        if (diff < 0 && !reminder.repeat) return "Time passed";
        const s = Math.floor(diff / 1000);
        const h = Math.floor(s / 3600);
        const m = Math.floor((s % 3600) / 60);
        const sec = s % 60;
        return ${h > 0 ? h + "h " : ""}${m > 0 ? m + "m " : ""}${sec}s;
      }

      function triggerAlert(reminder) {
        const reminderDiv = document.getElementById(reminder-${reminder.id});
        if (reminderDiv) reminderDiv.classList.add("alert");

        const alarm = document.getElementById("alarmSound");
        let repeatCount = reminder.priority === "High" ? 6 : reminder.priority === "Medium" ? 4 : 2;
        let spokenCount = 0;

        function repeatAlert() {
          if (spokenCount < repeatCount) {
            alarm.play().catch(() => {});
            speak(It's time to take your ${reminder.med});
            spokenCount++;
            setTimeout(repeatAlert, 2500);
          } else {
            showConfirmPopup(reminder.med, reminder.id, reminder.repeat);
          }
        }

        repeatAlert();
      }

      function checkReminders() {
        const now = new Date();
        reminders.forEach(r => {
          let remTime = r.timestamp ? new Date(r.timestamp) : new Date();
          if (r.repeat && remTime < now) remTime.setDate(remTime.getDate() + 1);
          const diffSec = Math.floor((remTime - now) / 1000);
          const leftSpan = document.getElementById(time-left-${r.id});
          if (leftSpan) {
            leftSpan.textContent = diffSec > 0 ? "Time left: " + getTimeLeftString(r) : "Time left: Now!";
          }

          if (diffSec >= 0 && diffSec <= 5 && !activeAlerts.has(r.id)) {
            activeAlerts.add(r.id);
            triggerAlert(r);
          }

          if (diffSec < 0 || diffSec > 5) {
            activeAlerts.delete(r.id);
            const d = document.getElementById(reminder-${r.id});
            if (d && d.classList.contains("alert")) d.classList.remove("alert");
          }
        });
      }

      setInterval(checkReminders, 1000);

      function showPopup(title, message) {
        document.getElementById("popupTitle").textContent = title;
        document.getElementById("popupContent").textContent = message;
        document.getElementById("popupOverlay").style.display = "flex";
      }

      function closePopup() {
        document.getElementById("popupOverlay").style.display = "none";
      }

      let confirmReminderId = null;
      let confirmReminderRepeat = false;

      function showConfirmPopup(med, id, repeat) {
        confirmReminderId = id;
        confirmReminderRepeat = repeat;
        document.getElementById("confirmMessage").textContent = It’s time for your ${med} — have you taken it yet?;
        document.getElementById("confirmPopupOverlay").style.display = "flex";
      }

      function confirmTaken() {
        document.getElementById("confirmPopupOverlay").style.display = "none";
        if (!confirmReminderRepeat && confirmReminderId) {
          deleteReminder(confirmReminderId);
        }
        confirmReminderId = null;
        confirmReminderRepeat = false;
      }
    </script>
  </body>
</html>
